<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pusher Test</title>
    <script src="https://js.pusher.com/7.1/pusher.min.js"></script>

    <script src="js/pusherVARS.js"></script>
  <script src="js/detectBROWSER.js"></script>
    <script src="js/pusherEVENTS.js"></script>
    <script src="js/pusherCLASSES.js">    </script>

    <script src="js/pusherLOGGER.js">    </script>

</head>
<body>
<h1>Pusher Test</h1>


Enter Name : <input type="text" id="txtUSERNAME" /> <button onclick="setNAME()">SET NAME TO LOGIN</button>

<div id="user_INFO"></div>


<div id="user_list"></div>
<BR><BR>

<button onclick="connectPUSHER()">Connect</button>

<button onclick="disconnectPUSHER()">Diconnect</button>


<button onclick="channelName='private-'+'ishopper';">PRIV CHAN</button>
<button onclick="channelName='presence-'+'ishopper';">PRES CHAN </button><BR>


<button onclick="signinUSER()">SIGN IN</button>

<button onclick="subUSER(channelName)">SUB IN CHANNEL</button>


<button onclick="getROOMUSER(channelName)">ROOM USER</button>
<BR>

INPUT  <select id="audioInputSelect"></select>
OUTPUT <select id="audioOutputSelect"></select>


INPUT  <select id="videoSelect"></select>


<script>
    let videoSelect=document.getElementById("videoSelect");
    let audioInputSelect=document.getElementById("audioInputSelect");
    let audioOutputSelect=document.getElementById("audioOutputSelect");

    navigator.mediaDevices.enumerateDevices()
        .then(gotDevices)
        .catch(errorCallback);

    function errorCallback(myERR){
        console.log(myERR);
    }

    function gotDevices(deviceInfos) {
        for (let i = 0; i !== deviceInfos.length; ++i) {
            let deviceInfo = deviceInfos[i];
            let option = document.createElement('option');
            option.value = "device" + deviceInfo.deviceId;
            option.id = deviceInfo.deviceId;
            if(document.getElementById(option.id)!=null){}
            else{
                if (deviceInfo.kind === 'audioinput') {
                    option.text = deviceInfo.label ||
                        'Microphone ' + (audioInputSelect.length + 1);
                    audioInputSelect.appendChild(option);
                }
                else if (deviceInfo.kind === 'audiooutput') {
                    option.text = deviceInfo.label || 'Speaker ' +
                        (audioOutputSelect.length + 1);
                    audioOutputSelect.appendChild(option);
                }
                else if (deviceInfo.kind === 'videoinput') {
                    option.text = deviceInfo.label || 'Camera ' +
                        (videoSelect.length + 1);
                    videoSelect.appendChild(option);
                }
            }

        }
    }
</script>
<div id="divRTCBITRATE"></div>
<div id="divRTCSTATS"></div>
<div id="divLOGSTAT"></div>
<div id="divLOG"></div>



<div id="mydivWITHVID">
    <!-- Include a header DIV with the same name as the draggable DIV, followed by "header" -->
    <div id="mydivWITHVIDheader">Click here to move  <button id="b1" onclick="fadein()">[CLOSE]</button> </div>
    <video id="localVideo" playsinline autoplay muted></video> <br />
    Other Videos :<div id="divREMOTES"></div><br />

    <!-- <video id="remoteVideo" playsinline autoplay muted></video> <br />-->


    <!--  <div>
       <button id="startButton">Start</button>
       <button id="callButton">Call</button>
       <button id="hangupButton">Hang Up</button>
   </div>-->
</div>

<BR><BR>
<div id="divMSGsent"></div>
<div id="divMSGrecd"></div>



<script src="js/pusherLISTENERS.js"></script>


<script src="js/pusherUTILS.js"></script>
 <script src="js/pusherRTC.js"></script>


<script>
    var agentInfo   = detect.parse(navigator.userAgent);

   // console.log(agentInfo.browser.family);

    var divMSG=document.getElementById("divMSG");
    var divLOG=document.getElementById("divLOG");
  //

    function setNAME(){

        var thisUSERNAME=document.getElementById("txtUSERNAME").value;

        if(thisUSERNAME=="" || thisUSERNAME==undefined){
            myPAGEUSER.name="GUEST_"+IDGenerate();
        }
        else{
            myPAGEUSER.name=thisUSERNAME;
        }

            if(pusher==null){setPUSHERJS();}
            else{
                console.log("ALREADY SET");
            }


        signinUSER();

        subUSER(myEVENTS.channelName);

    }



    function setPUSHERJS(){
        pusher =  new Pusher('6ad64e86fc885ee2bb0a', {
            userAuthentication: {
                endpoint: "/pusher/auth",
                // endpoint: "localhost:3000/pusher/user-auth",
                transport: "ajax",
                params:{name:myPAGEUSER.name,jsID:myPAGEUSER.jsID,time:new Date().getTime()},
                headers: {},
                customHandler: null,
                //     transport: "jsonp",

            },
            channelAuthorization: {
                endpoint: "/pusher/auth",
                transport: "ajax",
                params: {name:myPAGEUSER.name,jsID:myPAGEUSER.jsID,time:new Date().getTime()},
                headers: {},
                customHandler: null,
            },
            // authEndpoint: 'https://ishopper.info/pusher/user-auth',
            //  userAuthentication: { endpoint: "/pusher_user_auth.php"},

            encrypted: false, // local only
            //  forceTLS: true,
            cluster: 'ap1',
            enabledTransports: ['ws', 'xhr_streaming'],
            //   disabledTransports: ['xhr_streaming']
        });

        pusher.user.bind("client-sysmsg", function(data)  {
            console.log("client-sysmsg DATA NOW : "+JSON.stringify(data));
            document.getElementById("divLOG").innerHTML=JSON.stringify(data);

        });

        pusher.connection.bind("state_change", function (states) {
            // states = {previous: 'oldState', current: 'newState'}
            //  $("div#status").text("Channels current state is " + states.current);
            console.log(JSON.stringify(states));
            document.getElementById("user_INFO").innerHTML=JSON.stringify(myPAGEUSER);
        });
    }

// Enable pusher logging - don't include this in production
// Pusher.logToConsole = true;


    /*  var callback = (data) => {
          // add comment into page
          console.log(JSON.stringify(data));
      };

      pusher.bind(eventName, callback);*/
</script>
</body>
</html>


<!-- index.html
<html>
<body>
<div id="user_list"></div>
<script src="https://js.pusher.com/7.0.3/pusher.min.js"></script>
<script>
  Pusher.logToConsole = true;
  const pusher = new Pusher(
          "6ad64e86fc885ee2bb0a", // Replace with 'key' from dashboard
          {
            cluster: "ap1", // Replace with 'cluster' from dashboard
            forceTLS: true,
            channelAuthorization: {
              endpoint: "http://192.168.0.50:3000/pusher/user-auth",
            }
          }
  );
  if (!document.cookie.match("(^|;) ?user_id=([^;]*)(;|$)")) {
    // Primitive authorization! This 'user_id' cookie is read by your authorization endpoint,
    // and used as the user_id in the subscription to the 'presence-quickstart'
    // channel. This is then displayed to all users in the user list.
    // In your production app, you should use a secure authorization system.
    document.cookie = "user_id=" + prompt("Your initials:");
  }
  const channel = pusher.subscribe("presence-quickstart");
  const hashCode = (s) =>
          s.split("").reduce((a, b) => {
            a = (a << 5) - a + b.charCodeAt(0);
            return a & a;
          }, 0);
  function addMemberToUserList(memberId) {
    userEl = document.createElement("div");
    userEl.id = "user_" + memberId;
    userEl.innerText = memberId;
    userEl.style.backgroundColor =
            "hsl(" + (hashCode(memberId) % 360) + ",70%,60%)";
    document.getElementById("user_list").appendChild(userEl);
  }
  channel.bind("pusher:subscription_succeeded", () =>
          channel.members.each((member) => addMemberToUserList(member.id))
  );
  channel.bind("pusher:member_added", (member) =>
          addMemberToUserList(member.id)
  );
  channel.bind("pusher:member_removed", (member) => {
    const userEl = document.getElementById("user_" + member.id);
    userEl.parentNode.removeChild(userEl);
  });
</script>
<style>
  body {
    margin: 1em;
  }
  #user_list div {
    float: right;
    margin-left: -12px;
    font-family: sans-serif;
    text-align: center;
    height: 40px;
    width: 40px;
    line-height: 40px;
    border-radius: 50%;
    border: 3px solid white;
    color: white;
  }
</style>
</body>
</html>

-->